name: Build iOS IPA

on:
  push:
    branches: [main, master]
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.4.app/Contents/Developer

      - name: Install xcodegen
        run: brew install xcodegen

      - name: Generate Xcode project
        run: xcodegen generate

      - name: Show project structure
        run: |
          echo "=== Generated project ==="
          ls -la MyApp.xcodeproj/
          echo "=== Source files ==="
          find MyApp -name "*.swift" -o -name "*.plist" -o -name "*.json" | sort

      - name: Build for iOS device (arm64, unsigned)
        run: |
          xcodebuild \
            -project MyApp.xcodeproj \
            -scheme MyApp \
            -configuration Release \
            -destination 'generic/platform=iOS' \
            -derivedDataPath build \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            ONLY_ACTIVE_ARCH=NO \
            ARCHS=arm64 \
            build

      - name: Package IPA
        run: |
          echo "=== Finding .app bundle ==="
          APP_PATH=$(find build -name "MyApp.app" -type d | head -1)
          echo "Found: $APP_PATH"

          # Create Payload structure
          mkdir -p Payload
          cp -R "$APP_PATH" Payload/

          # Create IPA (IPA is just a zip with Payload/ inside)
          zip -r MyApp-unsigned.ipa Payload/

          echo "=== IPA created ==="
          ls -lh MyApp-unsigned.ipa

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: MyApp-unsigned-ipa
          path: MyApp-unsigned.ipa
          retention-days: 30

      - name: Build summary
        run: |
          echo "## Build Complete ✅" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**IPA**: MyApp-unsigned.ipa" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### How to install on your iPhone:" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the IPA from the **Artifacts** section below" >> $GITHUB_STEP_SUMMARY
          echo "2. Install **AltStore** on your Windows PC from [altstore.io](https://altstore.io)" >> $GITHUB_STEP_SUMMARY
          echo "3. Connect your iPhone via USB" >> $GITHUB_STEP_SUMMARY
          echo "4. Open AltStore → My Apps → tap **+** → select the IPA" >> $GITHUB_STEP_SUMMARY
          echo "5. Sign in with your free Apple ID when prompted" >> $GITHUB_STEP_SUMMARY
          echo "6. AltStore will re-sign and install the app" >> $GITHUB_STEP_SUMMARY
